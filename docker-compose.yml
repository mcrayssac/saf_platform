services:
  # Zookeeper - Kafka coordination
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: saf-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - saf-network
    restart: unless-stopped

  # Kafka - Message broker for inter-pod messaging
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: saf-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 24
    networks:
      - saf-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # SAF Control - Central registry and coordination service
  saf-control:
    build:
      context: .
      dockerfile: ./backend/framework/saf-control/Dockerfile
    container_name: saf-control
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      # Security
      SAF_SECURITY_API_KEY: ${SAF_API_KEY:-mock-secret}
      # JVM options
      JAVA_OPTS: -Xmx512m -Xms256m
    networks:
      - saf-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Client Service - Microservice for ClientActor
  client-service:
    build:
      context: .
      dockerfile: ./backend/apps/iot-city/client-service/Dockerfile
    container_name: client-service
    depends_on:
      saf-control:
        condition: service_healthy
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SAF_CONTROL_URL: http://saf-control:8080
      SAF_CONTROL_API_KEY: ${SAF_API_KEY:-mock-secret}
      SERVICE_URL: http://client-service:8084
      JAVA_OPTS: -Xmx256m -Xms128m
    networks:
      - saf-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Ville Service - Microservice for VilleActor
  ville-service:
    build:
      context: .
      dockerfile: ./backend/apps/iot-city/ville-service/Dockerfile
    container_name: ville-service
    depends_on:
      saf-control:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "8085:8085"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SAF_CONTROL_URL: http://saf-control:8080
      SAF_CONTROL_API_KEY: ${SAF_API_KEY:-mock-secret}
      SERVICE_URL: http://ville-service:8085
      KAFKA_BROKERS: kafka:9092
      MESSAGING_BROKER_TYPE: kafka
      JAVA_OPTS: -Xmx256m -Xms128m
    networks:
      - saf-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Capteur Service - Microservice for CapteurActor
  capteur-service:
    build:
      context: .
      dockerfile: ./backend/apps/iot-city/capteur-service/Dockerfile
    container_name: capteur-service
    depends_on:
      saf-control:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "8086:8086"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SAF_CONTROL_URL: http://saf-control:8080
      SAF_CONTROL_API_KEY: ${SAF_API_KEY:-mock-secret}
      SERVICE_URL: http://capteur-service:8086
      KAFKA_BROKERS: kafka:9092
      MESSAGING_BROKER_TYPE: kafka
      JAVA_OPTS: -Xmx256m -Xms128m
    networks:
      - saf-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Frontend - React UI
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: ${VITE_API_BASE:-http://saf-control:8080/api/v1}
        VITE_API_KEY: ${SAF_API_KEY:-mock-secret}
    container_name: saf-frontend
    depends_on:
      saf-control:
        condition: service_healthy
    ports:
      - "80:80"
    networks:
      - saf-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Prometheus - Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: saf-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    depends_on:
      - saf-control
      - client-service
      - ville-service
      - capteur-service
    networks:
      - saf-network
    restart: unless-stopped

networks:
  saf-network:
    driver: bridge
    name: saf-network
