package com.acme.saf.saf_control.application;

import com.acme.saf.saf_control.domain.dto.AgentStatus;
import com.acme.saf.saf_control.domain.dto.AgentView;
import com.acme.saf.saf_control.domain.dto.Agent.SupervisionPolicy;
import org.springframework.stereotype.Service;

/**
 * Service responsable d'appliquer les politiques de supervision
 * lorsque des agents deviennent inactifs ou rencontrent une erreur.
 */
@Service
public class SupervisionService {

    // RÃ©fÃ©rence au service de contrÃ´le pour dÃ©truire/redÃ©marrer les agents
    private final ControlService controlService;

    // Constructeur avec injection de dÃ©pendance
    public SupervisionService(ControlService controlService) {
        this.controlService = controlService;
    }

    /**
     * Applique la politique de supervision pour un agent donnÃ©.
     * Cette mÃ©thode est appelÃ©e lorsquâ€™un agent est dÃ©tectÃ© comme inactif.
     *
     * @param agent lâ€™agent concernÃ©
     */
    public void handle(AgentView agent) {
        // RÃ©cupÃ©ration de la politique de supervision dÃ©finie pour cet agent
        SupervisionPolicy policy = agent.policy(); // Assure-toi que le getter existe
        String agentId = agent.id(); // Identifiant unique de lâ€™agent

        // Application de la bonne action selon la politique
        switch (policy) {
            case RESTART -> {
                // Politique : redÃ©marrer lâ€™agent (ici on le dÃ©truit dâ€™abord)
                System.out.println("ðŸ” Supervision : redÃ©marrage de lâ€™agent " + agentId);
                controlService.destroy(agentId);
                // Pour redÃ©marrer, tu pourrais ici relancer un agent avec les mÃªmes paramÃ¨tres
            }
            case STOP -> {
                // Politique : arrÃªt dÃ©finitif de lâ€™agent
                System.out.println("â›” Supervision : arrÃªt de lâ€™agent " + agentId);
                controlService.destroy(agentId);
            }
            case QUARANTINE -> {
                // Politique : mettre lâ€™agent de cÃ´tÃ© sans le supprimer
                System.out.println("ðŸŸ¡ Supervision : quarantaine de lâ€™agent " + agentId);
                // Ici, tu pourrais marquer son statut comme QUARANTINED dans le registre
                // ou l'exclure temporairement des traitements
            }
            case RESUME -> {
                // Politique : ne rien faire (ignorer lâ€™erreur)
                System.out.println("âœ… Supervision : erreur ignorÃ©e pour lâ€™agent " + agentId);
            }
        }
    }
}
